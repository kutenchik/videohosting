
{% extends 'admin/base.html' %}
{% block title %}Админ: Комментарии{% endblock %}

{% block admin_content %}

<div class="content-header">
  <h1>Управление комментариями</h1>
  <div>
    <span class="badge bg-primary">Всего: {{ comments|length }}</span>
  </div>
</div>

<div class="filter-container">
  <div class="row g-2">
    <div class="col-md-3">
      <div class="input-group">
        <span class="input-group-text"><i class="fas fa-video"></i></span>
        <input id="filterVid" class="form-control" placeholder="Название видео">
      </div>
    </div>
    <div class="col-md-2">
      <div class="input-group">
        <span class="input-group-text"><i class="fas fa-user"></i></span>
        <input id="filterAuth" class="form-control" placeholder="Автор">
      </div>
    </div>
    <div class="col-md-3">
      <div class="input-group">
        <span class="input-group-text"><i class="fas fa-comment"></i></span>
        <input id="filterText" class="form-control" placeholder="Текст комментария">
      </div>
    </div>
    <div class="col-md-2">
      <div class="input-group">
        <span class="input-group-text"><i class="fas fa-calendar"></i></span>
        <input type="date" id="filterDateFrom" class="form-control" title="Дата от">
      </div>
    </div>
    <div class="col-md-2">
      <div class="input-group">
        <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
        <input type="date" id="filterDateTo" class="form-control" title="Дата до">
      </div>
    </div>
  </div>
  <div class="row mt-2">
    <div class="col-md-12">
      <div class="input-group">
        <span class="input-group-text"><i class="fas fa-filter"></i></span>
        <select id="filterStatus" class="form-select">
          <option value="">Статус – все</option>
          <option value="активен">Активные</option>
          <option value="забанен">Забаненные</option>
        </select>
        <button class="btn btn-primary" id="resetFilters">
          <i class="fas fa-sync-alt me-1"></i>Сбросить фильтры
        </button>
      </div>
    </div>
  </div>
</div>

<div class="data-table">
  <table id="commentsTable" class="table table-hover">
    <thead>
      <tr>
        <th width="5%">ID</th>
        <th width="20%">Видео</th>
        <th width="15%">Автор</th>
        <th width="30%">Комментарий</th>
        <th width="10%">Дата</th>
        <th width="10%">Статус</th>
        <th width="10%">Действия</th>
      </tr>
    </thead>
    <tbody>
      {% for c in comments %}
      <tr class="{% if c.is_banned %}table-danger{% endif %}">
        <td>{{ c.comment_id }}</td>
        <td>
          <a href="{{ url_for('watch_video', video_id=c.video.video_id) }}" class="text-decoration-none">
            <div class="d-flex align-items-center">
              <div class="avatar-sm me-2 bg-light rounded d-flex align-items-center justify-content-center">
                <i class="fas fa-video text-secondary"></i>
              </div>
              <div class="text-truncate" style="max-width: 150px;">{{ c.video.title }}</div>
            </div>
          </a>
        </td>
        <td>
          <div class="d-flex align-items-center">
            <div class="avatar-sm me-2 bg-light rounded-circle d-flex align-items-center justify-content-center">
              <i class="fas fa-user text-secondary"></i>
            </div>
            <div>{{ c.author.username }}</div>
          </div>
        </td>
        <td>
            <div class="comment-content">
              <div class="short-comment text-truncate" style="max-width: 300px;">{{ c.content|truncate(50) }}</div>
              <div class="full-comment d-none" style=" word-wrap: break-word;max-width:300px;">{{ c.content }}</div>
              <button class="btn btn-sm btn-link p-0 mt-1 toggle-comment">Показать полностью</button>
            </div>
          </td>
          
        <td>{{ c.created_at.strftime('%Y-%m-%d') }}</td>
        <td>
          {% if c.is_banned %}
            <span class="badge bg-danger"><i class="fas fa-ban me-1"></i>Забанен</span>
          {% else %}
            <span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>Активен</span>
          {% endif %}
        </td>
        <td>
          {% if not c.is_banned %}
            <form method="post" action="{{ url_for('admin.ban_comment', comment_id=c.comment_id) }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-danger">
                <i class="fas fa-ban me-1"></i>Бан
              </button>
            </form>
          {% else %}
            <form method="post" action="{{ url_for('admin.unban_comment', comment_id=c.comment_id) }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-success">
                <i class="fas fa-check me-1"></i>Разбан
              </button>
            </form>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Модальное окно для просмотра полного комментария -->
<div class="modal fade" id="commentModal" tabindex="-1" aria-labelledby="commentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="commentModalLabel">Полный текст комментария</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="fullCommentText"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
      </div>
    </div>
  </div>
</div>

<script>
      
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.toggle-comment').forEach(btn => {
        btn.addEventListener('click', () => {
          const commentDiv = btn.closest('.comment-content');
          const shortText = commentDiv.querySelector('.short-comment');
          const fullText = commentDiv.querySelector('.full-comment');
    
          const isHidden = fullText.classList.contains('d-none');
          if (isHidden) {
            shortText.classList.add('d-none');
            fullText.classList.remove('d-none');
            btn.textContent = 'Скрыть';
          } else {
            shortText.classList.remove('d-none');
            fullText.classList.add('d-none');
            btn.textContent = 'Показать полностью';
          }
        });
      });
  const rows        = Array.from(document.querySelectorAll('#commentsTable tbody tr'));
  const fVid        = document.getElementById('filterVid');
  const fAuth       = document.getElementById('filterAuth');
  const fText       = document.getElementById('filterText');
  const fDateFrom   = document.getElementById('filterDateFrom');
  const fDateTo     = document.getElementById('filterDateTo');
  const fStatus     = document.getElementById('filterStatus');
  
  function applyFilter() {
    const vVid   = fVid.value.trim().toLowerCase();
    const vAuth  = fAuth.value.trim().toLowerCase();
    const vText  = fText.value.trim().toLowerCase();
    const dateFrom = fDateFrom.value ? new Date(fDateFrom.value) : null;
    const dateTo   = fDateTo.value   ? new Date(fDateTo.value)   : null;
    const vStatus = fStatus.value;

    let count = 0;

    rows.forEach(row => {
      const cols    = row.children;
      const title   = cols[1].textContent.toLowerCase();
      const author  = cols[2].textContent.toLowerCase();
      const text    = cols[3].textContent.toLowerCase();
      const dateStr = cols[4].textContent.trim(); // "YYYY-MM-DD"
      const date    = dateStr ? new Date(dateStr) : null;
      const status  = cols[5].textContent.trim().toLowerCase();

      const okVid  = !vVid   || title.includes(vVid);
      const okAuth = !vAuth  || author.includes(vAuth);
      const okText = !vText  || text.includes(vText);
      const okDateFrom = !dateFrom || (date && date >= dateFrom);
      const okDateTo   = !dateTo   || (date && date <= dateTo);
      const okStatus = !vStatus || status.includes(vStatus);

      const visible = (okVid && okAuth && okText && okDateFrom && okDateTo && okStatus);
      row.style.display = visible ? '' : 'none';
      if (visible) count++;
    });
    
    document.querySelector('.badge.bg-primary').textContent = `Показано: ${count} из ${rows.length}`;
  }
  // Навешиваем обработчики
  [fVid, fAuth, fText, fDateFrom, fDateTo].forEach(el =>
    el.addEventListener('input', applyFilter)
  );
  fStatus.addEventListener('change', applyFilter);
});
</script>
{% endblock %}
