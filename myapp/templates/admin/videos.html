{% extends 'admin/base.html' %}
{% block title %}Админ: Видео{% endblock %}

{% block admin_content %}

<div class="content-header">
  <h1>Управление видео</h1>
  <div>
    <span class="badge bg-primary">Всего: {{ videos|length }}</span>
  </div>
</div>

<div class="filter-container">
  <div class="row g-2">
    <div class="col-md-3">
      <div class="input-group">
        <span class="input-group-text"><i class="fas fa-film"></i></span>
        <input id="filterTitle" class="form-control" placeholder="Название видео">
      </div>
    </div>
    <div class="col-md-2">
      <div class="input-group">
        <span class="input-group-text"><i class="fas fa-user"></i></span>
        <input id="filterAuthor" class="form-control" placeholder="Автор">
      </div>
    </div>
    <div class="col-md-2">
      <div class="input-group">
        <span class="input-group-text"><i class="fas fa-calendar"></i></span>
        <input type="date" id="filterDateFrom" class="form-control" title="Дата от">
      </div>
    </div>
    <div class="col-md-2">
      <div class="input-group">
        <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
        <input type="date" id="filterDateTo" class="form-control" title="Дата до">
      </div>
    </div>
    <div class="col-md-3">
      <div class="input-group">
        <span class="input-group-text"><i class="fas fa-filter"></i></span>
        <select id="filterVStatus" class="form-select">
          <option value="">Статус – все</option>
          <option value="активно">Активные</option>
          <option value="забанено">Забаненные</option>
        </select>
        <button class="btn btn-primary" id="resetFilters">
          <i class="fas fa-sync-alt me-1"></i>Сбросить фильтры
        </button>
      </div>
    </div>
  </div>
</div>

<div class="data-table">
  <table id="videosTable" class="table table-hover">
    <thead>
      <tr>
        <th width="5%">ID</th>
        <th width="30%">Название</th>
        <th width="20%">Автор</th>
        <th width="15%">Дата</th>
        <th width="10%">Статус</th>
        <th width="20%">Действия</th>
      </tr>
    </thead>
    <tbody>
      {% for v in videos %}
      <tr class="{% if v.is_banned %}table-danger{% endif %}">
        <td>{{ v.video_id }}</td>
        <td>
          <a href="{{ url_for('watch_video', video_id=v.video_id) }}" class="text-decoration-none">
            <div class="d-flex align-items-center">
              <div class="avatar-sm me-2 bg-light rounded d-flex align-items-center justify-content-center">
                <i class="fas fa-film text-secondary"></i>
              </div>
              <div class="text-truncate" style="max-width: 250px;">{{ v.title }}</div>
            </div>
          </a>
        </td>
        <td>
          <div class="d-flex align-items-center">
            <div class="avatar-sm me-2 bg-light rounded-circle d-flex align-items-center justify-content-center">
              <i class="fas fa-user text-secondary"></i>
            </div>
            <div>{{ v.author.username }}</div>
          </div>
        </td>
        <td>{{ v.upload_date.strftime('%Y-%m-%d') }}</td>
        <td>
          {% if v.is_banned %}
            <span class="badge bg-danger"><i class="fas fa-ban me-1"></i>Забанено</span>
          {% else %}
            <span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>Активно</span>
          {% endif %}
        </td>
        <td>
          {% if not v.is_banned %}
            <form method="post" action="{{ url_for('admin.ban_video', video_id=v.video_id) }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-danger">
                <i class="fas fa-ban me-1"></i>Бан
              </button>
            </form>
          {% else %}
            <form method="post" action="{{ url_for('admin.unban_video', video_id=v.video_id) }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-success">
                <i class="fas fa-check me-1"></i>Разбан
              </button>
            </form>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const rows = Array.from(document.querySelectorAll('#videosTable tbody tr'));
  const fTitle = document.getElementById('filterTitle');
  const fAuth = document.getElementById('filterAuthor');
  const fDateFrom = document.getElementById('filterDateFrom');
  const fDateTo = document.getElementById('filterDateTo');
  const fStatus = document.getElementById('filterVStatus');
  const resetBtn = document.getElementById('resetFilters');
  
  function applyFilter() {
    const vTitle = fTitle.value.trim().toLowerCase();
    const vAuth = fAuth.value.trim().toLowerCase();
    const dateFrom = fDateFrom.value ? new Date(fDateFrom.value) : null;
    const dateTo = fDateTo.value ? new Date(fDateTo.value) : null;
    const vStatus = fStatus.value.toLowerCase();

    let count = 0;

    rows.forEach(row => {
      const cols = row.children;
      const title = cols[1].textContent.toLowerCase();
      const author = cols[2].textContent.toLowerCase();
      const dateStr = cols[3].textContent.trim(); // "YYYY-MM-DD"
      const date = dateStr ? new Date(dateStr) : null;
      const status = cols[4].textContent.trim().toLowerCase();

      const okTitle = !vTitle || title.includes(vTitle);
      const okAuth = !vAuth || author.includes(vAuth);
      const okDateFrom = !dateFrom || (date && date >= dateFrom);
      const okDateTo = !dateTo || (date && date <= dateTo);
      const okStatus = !vStatus || status.includes(vStatus);

      const visible = (okTitle && okAuth && okDateFrom && okDateTo && okStatus);
      row.style.display = visible ? '' : 'none';
      if (visible) count++;
    });
    
    document.querySelector('.badge.bg-primary').textContent = `Показано: ${count} из ${rows.length}`;
  }
  
  function resetFilters() {
    fTitle.value = '';
    fAuth.value = '';
    fDateFrom.value = '';
    fDateTo.value = '';
    fStatus.value = '';
    
    rows.forEach(row => {
      row.style.display = '';
    });
    
    document.querySelector('.badge.bg-primary').textContent = `Всего: ${rows.length}`;
  }
  
  // Навешиваем обработчики
  [fTitle, fAuth, fDateFrom, fDateTo].forEach(el =>
    el.addEventListener('input', applyFilter)
  );
  fStatus.addEventListener('change', applyFilter);
  resetBtn.addEventListener('click', resetFilters);
});
</script>
{% endblock %}