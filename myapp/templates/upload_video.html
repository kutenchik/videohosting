{% extends 'base.html' %}

{% block title %}Загрузить видео{% endblock %}

{% block content %}
<div class="upload-container">
  <div class="upload-header">
    <h2>Загрузить видео</h2>
    <p class="text-muted">Поделитесь своим кулинарным шедевром с миром</p>
  </div>
  
  <form method="POST" enctype="multipart/form-data" action="{{ url_for('upload') }}" class="upload-form">
    {{ form.hidden_tag() }}
    
    <div class="form-section">
      <h4>Основная информация</h4>
      <div class="form-group">
        {{ form.title.label(class="form-label") }}
        {{ form.title(class="form-control", placeholder="Введите название вашего видео") }}
      </div>
      
      <div class="form-group">
        {{ form.description.label(class="form-label") }}
        {{ form.description(class="form-control", rows="5", placeholder="Опишите ваше видео...") }}
      </div>
      
      <div class="form-group">
        {{ form.tags.label(class="form-label") }}
        {{ form.tags(class="form-control", placeholder="салат, здоровая пища, веганское") }}
        <small class="form-text text-muted">Введите теги через запятую</small>
      </div>
    </div>
    
    <div class="form-section">
      <h4>Медиафайлы</h4>
      <div class="media-upload-container">
        <div class="form-group file-upload-wrapper">
          <label for="{{ form.video.id }}" class="file-upload-label">
            <i class="fas fa-film"></i>
            <span>{{ form.video.label.text }}</span>
          </label>
          {{ form.video(class="form-control-file", id=form.video.id, accept="video/*") }}
          <div class="file-name" id="video-file-name">Файл не выбран</div>
        </div>
        
        <div class="form-group file-upload-wrapper">
          <label for="{{ form.thumbnail.id }}" class="file-upload-label">
            <i class="fas fa-image"></i>
            <span>{{ form.thumbnail.label.text }}</span>
          </label>
          {{ form.thumbnail(class="form-control-file", id=form.thumbnail.id, accept="image/*") }}
          <div class="file-name" id="thumbnail-file-name">Файл не выбран</div>
        </div>
      </div>
    </div>
    
    <div class="form-section">
      <h4>Ингредиенты</h4>
      <div id="ingredients-container">
        <div class="ingredient-input">
          <div class="ingredient-row">
            <div class="ingredient-name">
              <input type="text" name="ingredient_name[]" class="form-control" placeholder="Название ингредиента">
            </div>
            <div class="ingredient-amount">
              <input type="text" name="ingredient_amount[]" class="form-control" placeholder="Количество">
            </div>
            <div class="ingredient-remove" style="visibility: hidden;">
              <button type="button" class="btn-remove-ingredient">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
      <button type="button" class="btn btn-add-ingredient" id="add-ingredient-button">
        <i class="fas fa-plus"></i> Добавить ингредиент
      </button>
    </div>
    
    <div class="form-section">
      <h4>Настройки публикации</h4>
      
      <div class="form-group publication-settings">
        <div class="scheduling-option">
          <input type="radio" name="publish_option" id="publish_now" value="now" checked>
          <label for="publish_now">Опубликовать сейчас</label>
        </div>
        
        <div class="scheduling-option">
          <input type="radio" name="publish_option" id="publish_later" value="later">
          <label for="publish_later">Запланировать публикацию</label>
        </div>
        
        <div id="schedule-container" class="schedule-container">
          <div class="schedule-datetime">
            <div class="schedule-date">
              <label>Дата публикации</label>
              <input type="date" id="schedule_date" name="schedule_date" class="form-control" disabled>
            </div>
            <div class="schedule-time">
              <label>Время публикации</label>
              <input type="time" id="schedule_time" name="schedule_time" class="form-control" disabled>
            </div>
          </div>
          <!-- Скрытое поле для сохранения значения в формате, ожидаемом сервером -->
          <input type="hidden" name="scheduled_at" id="scheduled_at" value="">
        </div>
      <!--
      <div class="form-group form-check archive-check">
        {{ form.is_archived(class="form-check-input") }}
        {{ form.is_archived.label(class="form-check-label") }}
        <small class="form-text text-muted">Архивное видео будет доступно только вам</small>
      </div>
    </div>
    -->
    <div class="form-actions">
      <button type="button" class="btn btn-outline-secondary btn-cancel">Отмена</button>
      <button type="submit" class="btn btn-primary btn-upload">{{ form.submit.label.text }}</button>
    </div>
  </form>
</div>


<style>
  /* Улучшенные стили для формы загрузки */
  .upload-container {
    max-width: 800px;
    margin: 40px auto;
    background-color: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    padding: 30px;
  }
  
  .upload-header {
    margin-bottom: 30px;
    text-align: center;
  }
  
  .upload-header h2 {
    font-weight: 700;
    color: #0d0d0d;
    margin-bottom: 5px;
  }
  
  .upload-form .form-section {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid #f0f0f0;
  }
  
  .upload-form .form-section:last-child {
    border-bottom: none;
  }
  
  .upload-form h4 {
    font-size: 18px;
    font-weight: 600;
    color: #0d0d0d;
    margin-bottom: 20px;
  }
  
  .form-label {
    font-weight: 500;
    margin-bottom: 8px;
    display: block;
  }
  
  .form-control {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 12px;
    font-size: 15px;
    transition: all 0.2s;
    margin-bottom: 16px;
  }
  
  .form-control:focus {
    border-color: #9370db;
    box-shadow: 0 0 0 3px rgba(147, 112, 219, 0.15);
  }
  
  .form-text {
    color: #606060;
    font-size: 13px;
    margin-top: -12px;
    margin-bottom: 16px;
  }
  
  /* Стили для загрузки файлов */
  .media-upload-container {
    display: flex;
    gap: 20px;
    margin-bottom: 10px;
  }
  
  @media (max-width: 768px) {
    .media-upload-container {
      flex-direction: column;
    }
  }
  
  .file-upload-wrapper {
    flex: 1;
    position: relative;
  }
  
  .file-upload-label {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border: 2px dashed #ccc;
    border-radius: 8px;
    padding: 30px 20px;
    cursor: pointer;
    transition: all 0.2s;
    background-color: #f9f9f9;
    text-align: center;
  }
  
  .file-upload-label:hover {
    border-color: #9370db;
    background-color: #f5f0ff;
  }
  
  .file-upload-label i {
    font-size: 32px;
    color: #9370db;
    margin-bottom: 10px;
  }
  
  .form-control-file {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }
  
  .file-name {
    margin-top: 10px;
    font-size: 14px;
    color: #606060;
    text-align: center;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  /* Стили для ингредиентов */
  .ingredient-input {
    margin-bottom: 10px;
  }
  
  .ingredient-row {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .ingredient-name {
    flex: 3;
  }
  
  .ingredient-amount {
    flex: 2;
  }
  
  .ingredient-remove {
    flex: 0 0 36px;
    display: flex;
    justify-content: center;
  }
  
  .btn-remove-ingredient {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: none;
    background: #f1f1f1;
    color: #ff4d4d;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }
  
  .btn-remove-ingredient:hover {
    background: #ffeeee;
  }
  
  .btn-add-ingredient {
    background: transparent;
    border: 1px solid #9370db;
    color: #9370db;
    border-radius: 20px;
    padding: 8px 16px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 5px;
    transition: all 0.2s;
  }
  
  .btn-add-ingredient:hover {
    background: #f5f0ff;
  }
  
  /* Стили для планирования публикации */
  .publication-settings {
    margin-bottom: 20px;
  }
  
  .scheduling-option {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
  }
  
  .scheduling-option input[type="radio"] {
    margin-right: 10px;
  }
  
  .scheduling-option label {
    font-weight: 500;
    cursor: pointer;
  }
  
  .schedule-container {
    margin-top: 15px;
    padding-left: 25px;
    display: none; /* Скрыто по умолчанию */
  }
  
  .schedule-datetime {
    display: flex;
    gap: 15px;
  }
  
  .schedule-date, .schedule-time {
    flex: 1;
  }
  
  /* Стили для input type="date" и input type="time" */
  input[type="date"], input[type="time"] {
    padding: 10px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    width: 100%;
    font-family: inherit;
  }
  
  input[type="date"]:focus, input[type="time"]:focus {
    border-color: #9370db;
    outline: none;
    box-shadow: 0 0 0 3px rgba(147, 112, 219, 0.15);
  }
  
  /* Стили для кнопок действий */
  .form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 15px;
    margin-top: 30px;
  }
  
  .btn {
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.2s;
    border: none;
    cursor: pointer;
  }
  
  .btn-outline-secondary {
    background: transparent;
    border: 1px solid #ccc;
    color: #606060;
  }
  
  .btn-outline-secondary:hover {
    background: #f1f1f1;
  }
  
  .btn-primary {
    background: #9370db;
    color: white;
  }
  
  .btn-primary:hover {
    background: #8360cb;
  }
  
  .btn-upload {
    min-width: 140px;
  }
  
  /* Стили для чекбокса архивации */
  .archive-check {
    display: flex;
    align-items: flex-start;
    margin-top: 10px;
  }
  
  .form-check-input {
    margin-top: 4px;
    margin-right: 8px;
  }
  
  .form-check-label {
    font-weight: 500;
  }
</style>
<script>
  // Скрипт для отображения имени выбранного файла
  document.addEventListener('DOMContentLoaded', function() {
    // Обработка выбора видеофайла
    const videoInput = document.getElementById('{{ form.video.id }}');
    const videoFileName = document.getElementById('video-file-name');
    
    videoInput.addEventListener('change', function() {
      if (this.files && this.files[0]) {
        videoFileName.textContent = this.files[0].name;
      } else {
        videoFileName.textContent = 'Файл не выбран';
      }
    });
    
    // Обработка выбора файла миниатюры
    const thumbnailInput = document.getElementById('{{ form.thumbnail.id }}');
    const thumbnailFileName = document.getElementById('thumbnail-file-name');
    
    thumbnailInput.addEventListener('change', function() {
      if (this.files && this.files[0]) {
        thumbnailFileName.textContent = this.files[0].name;
      } else {
        thumbnailFileName.textContent = 'Файл не выбран';
      }
    });
    
    // Функция для добавления ингредиентов
    const addIngredientBtn = document.getElementById('add-ingredient-button');
    const ingredientsContainer = document.getElementById('ingredients-container');
    
    // Активируем первую кнопку удаления
    const firstRemoveBtn = document.querySelector('.ingredient-remove');
    if (firstRemoveBtn) {
      firstRemoveBtn.style.visibility = 'hidden';
    }
    
    addIngredientBtn.addEventListener('click', function() {
      // Делаем видимыми все кнопки удаления
      const allRemoveBtns = document.querySelectorAll('.ingredient-remove');
      allRemoveBtns.forEach(btn => {
        btn.style.visibility = 'visible';
      });
      
      // Создаем новый блок для ингредиента
      const newIngredient = document.createElement('div');
      newIngredient.classList.add('ingredient-input');
      newIngredient.innerHTML = `
        <div class="ingredient-row">
          <div class="ingredient-name">
            <input type="text" name="ingredient_name[]" class="form-control" placeholder="Название ингредиента">
          </div>
          <div class="ingredient-amount">
            <input type="text" name="ingredient_amount[]" class="form-control" placeholder="Количество">
          </div>
          <div class="ingredient-remove">
            <button type="button" class="btn-remove-ingredient">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
      `;
      
      // Добавляем новый блок в контейнер
      ingredientsContainer.appendChild(newIngredient);
      
      // Добавляем обработчик для кнопки удаления
      const removeBtn = newIngredient.querySelector('.btn-remove-ingredient');
      removeBtn.addEventListener('click', function() {
        newIngredient.remove();
        
        // Проверяем, остался ли только один ингредиент
        const remainingIngredients = ingredientsContainer.querySelectorAll('.ingredient-input');
        if (remainingIngredients.length === 1) {
          const lastRemoveBtn = remainingIngredients[0].querySelector('.ingredient-remove');
          lastRemoveBtn.style.visibility = 'hidden';
        }
      });
    });
    
    // Добавляем обработчики для существующих кнопок удаления
    document.querySelectorAll('.btn-remove-ingredient').forEach(btn => {
      btn.addEventListener('click', function() {
        const ingredientInput = this.closest('.ingredient-input');
        ingredientInput.remove();
        
        // Проверяем, остался ли только один ингредиент
        const remainingIngredients = ingredientsContainer.querySelectorAll('.ingredient-input');
        if (remainingIngredients.length === 1) {
          const lastRemoveBtn = remainingIngredients[0].querySelector('.ingredient-remove');
          lastRemoveBtn.style.visibility = 'hidden';
        }
      });
    });
    
    // Обработчик для кнопки отмены
    const cancelBtn = document.querySelector('.btn-cancel');
    if (cancelBtn) {
      cancelBtn.addEventListener('click', function() {
        window.history.back();
      });
    }
    
    // Обработка переключателя для планирования публикации
    const publishNowRadio = document.getElementById('publish_now');
    const publishLaterRadio = document.getElementById('publish_later');
    const scheduleContainer = document.getElementById('schedule-container');
    const scheduleDateInput = document.getElementById('schedule_date');
    const scheduleTimeInput = document.getElementById('schedule_time');
    const scheduledAtInput = document.getElementById('scheduled_at');
    
    // Функция обновления поля scheduled_at для отправки на сервер
    function updateScheduledAt() {
      if (publishLaterRadio.checked && scheduleDateInput.value && scheduleTimeInput.value) {
        // Формат для MySQL: YYYY-MM-DD HH:MM:SS
        scheduledAtInput.value = `${scheduleDateInput.value} ${scheduleTimeInput.value}:00`;
      } else {
        scheduledAtInput.value = '';
      }
    }
    
    // Устанавливаем минимальную дату как сегодня
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const formattedToday = `${yyyy}-${mm}-${dd}`;
    scheduleDateInput.min = formattedToday;
    
    // Устанавливаем время по умолчанию через час
    const nextHour = new Date();
    nextHour.setHours(nextHour.getHours() + 1);
    const hours = String(nextHour.getHours()).padStart(2, '0');
    const minutes = String(nextHour.getMinutes()).padStart(2, '0');
    scheduleTimeInput.defaultValue = `${hours}:${minutes}`;
    
    publishNowRadio.addEventListener('change', function() {
      if (this.checked) {
        scheduleContainer.style.display = 'none';
        scheduleDateInput.disabled = true;
        scheduleTimeInput.disabled = true;
        updateScheduledAt();
      }
    });
    
    publishLaterRadio.addEventListener('change', function() {
      if (this.checked) {
        scheduleContainer.style.display = 'block';
        scheduleDateInput.disabled = false;
        scheduleTimeInput.disabled = false;
        scheduleDateInput.value = formattedToday;
        updateScheduledAt();
      }
    });
    
    // Обновляем hidden поле при изменении даты или времени
    scheduleDateInput.addEventListener('change', updateScheduledAt);
    scheduleTimeInput.addEventListener('change', updateScheduledAt);
    
    // Валидация формы перед отправкой
    const form = document.querySelector('.upload-form');
    form.addEventListener('submit', function(event) {
      if (publishLaterRadio.checked) {
        if (!scheduleDateInput.value) {
          alert('Пожалуйста, выберите дату публикации');
          event.preventDefault();
          return false;
        }
        if (!scheduleTimeInput.value) {
          alert('Пожалуйста, выберите время публикации');
          event.preventDefault();
          return false;
        }
        
        // Проверка, что выбранная дата и время не в прошлом
        const scheduledDateTime = new Date(`${scheduleDateInput.value}T${scheduleTimeInput.value}`);
        const now = new Date();
        
        if (scheduledDateTime <= now) {
          alert('Дата и время публикации должны быть в будущем');
          event.preventDefault();
          return false;
        }
      }
    });
  });
</script>
{% endblock %}